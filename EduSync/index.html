<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSync - Student ERP Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #1d4ed8; color: white; transform: translateX(4px); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login/Register Screen -->
    <div id="login-register-screen" class="min-h-screen flex items-center justify-center bg-blue-600">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            
            <!-- Login Form -->
            <div id="login-form-container">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">EduSync ERP</h1>
                    <p class="text-gray-500">Unified Student Management Platform</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                        <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                        Login
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? 
                    <a href="#" id="show-register-link" class="font-medium text-blue-600 hover:text-blue-500">Register here</a>
                </p>
            </div>

            <!-- Registration Form -->
            <div id="register-form-container" class="hidden">
                 <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Create Account</h1>
                    <p class="text-gray-500">Enter your details to register</p>
                </div>
                <form id="register-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="reg-name" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                            <input type="text" id="reg-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <div class="mb-4">
                            <label for="reg-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="reg-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="reg-phone" class="block text-gray-700 text-sm font-bold mb-2">Phone</label>
                        <input type="tel" id="reg-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label for="reg-dept" class="block text-gray-700 text-sm font-bold mb-2">Department</label>
                        <select id="reg-dept" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                            <option value="" disabled selected>Select your department</option>
                            <option value="1">Computer Science</option>
                            <option value="2">Electronics</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div class="mb-4">
                            <label for="reg-username" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                            <input type="text" id="reg-username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <div class="mb-4">
                            <label for="reg-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="reg-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                    </div>
                    <p id="register-message" class="text-xs italic mb-4 hidden"></p>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                        Register
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? 
                    <a href="#" id="show-login-link" class="font-medium text-blue-600 hover:text-blue-500">Login here</a>
                </p>
            </div>

        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-blue-700 text-white flex flex-col p-4 shadow-lg">
            <div class="text-2xl font-bold mb-8 border-b border-blue-500 pb-4">EduSync</div>
            <nav id="nav-links" class="flex-grow"></nav>
            <div id="user-profile" class="mt-auto">
                <div class="text-sm" id="user-info"></div>
                <button id="logout-btn" class="w-full mt-2 text-left bg-blue-800 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen">
            <header class="bg-white p-4 shadow-md flex justify-between items-center">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                <div class="text-sm text-gray-600">Smart India Hackathon 2025 Prototype</div>
            </header>
            <div id="content" class="flex-1 p-6 overflow-y-auto bg-gray-100"></div>
        </main>
    </div>

<script>
    // --- DOM ELEMENT REFERENCES ---
    const loginRegisterScreen = document.getElementById('login-register-screen');
    const appScreen = document.getElementById('app');
    const loginFormContainer = document.getElementById('login-form-container');
    const registerFormContainer = document.getElementById('register-form-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const logoutBtn = document.getElementById('logout-btn');
    const navLinks = document.getElementById('nav-links');
    const content = document.getElementById('content');
    const pageTitle = document.getElementById('page-title');
    const userInfo = document.getElementById('user-info');
    const loginError = document.getElementById('login-error');
    const registerMessage = document.getElementById('register-message');
    const showRegisterLink = document.getElementById('show-register-link');
    const showLoginLink = document.getElementById('show-login-link');

    let currentUser = null;
    let admissionsChart = null;
    let feesChart = null;

    // --- NAVIGATION SETUP ---
    const routes = {
        student: [
            { path: 'dashboard', name: 'Dashboard', icon: 'fa-tachometer-alt' },
            { path: 'academics', name: 'Academics', icon: 'fa-graduation-cap' },
            { path: 'fees', name: 'Fees', icon: 'fa-rupee-sign' },
            { path: 'library', name: 'Library', icon: 'fa-book' },
            { path: 'hostel', name: 'Hostel', icon: 'fa-hotel' },
        ],
        admin: [
            // This is the full admin sidebar from your working version
            { path: 'dashboard', name: 'Dashboard', icon: 'fa-tachometer-alt' },
            { path: 'students', name: 'Students', icon: 'fa-user-graduate' },
            { path: 'fees_all', name: 'Fee Management', icon: 'fa-file-invoice-dollar' },
            { path: 'academics_all', name: 'Academics', icon: 'fa-graduation-cap' },
            { path: 'library_all', name: 'Library', icon: 'fa-book-reader' },
            { path: 'hostel_all', name: 'Hostel', icon: 'fa-hotel' }
        ]
    };

    // --- RENDER FUNCTIONS ---

    function renderSidebar() {
        const userNav = routes[currentUser.role];
        if (!userNav) return;
        navLinks.innerHTML = userNav.map(link => `
            <a href="#" class="sidebar-link block py-2.5 px-4 rounded-lg text-sm font-medium mb-2" data-path="${link.path}">
                <i class="fas ${link.icon} w-6"></i>${link.name}
            </a>
        `).join('');
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('.sidebar-link.active')?.classList.remove('active');
                link.classList.add('active');
                navigateTo(link.dataset.path);
            });
        });
    }

    async function renderContent(path) {
        // --- STABILITY FIX ---
        // For dashboards, we will use the hardcoded functions to prevent errors.
        if (path === 'dashboard') {
            pageTitle.textContent = 'Dashboard';
            let html = '';
            if (currentUser.role === 'admin') {
                html = adminDashboard();
                content.innerHTML = `<div class="fade-in">${html}</div>`;
                renderAdminCharts(); 
            } else if (currentUser.role === 'student') {
                html = studentDashboard();
                content.innerHTML = `<div class="fade-in">${html}</div>`;
            }
            return; // Exit the function to avoid fetching data for dashboards
        }
        // --- END: STABILITY FIX ---

        content.innerHTML = '<div class="fade-in text-center p-10">Loading...</div>';
        const title = routes[currentUser.role].find(r => r.path === path)?.name || 'Page';
        pageTitle.textContent = title;

        try {
            const response = await fetch(`api/data.php?endpoint=${path}`);
            if (!response.ok) throw new Error(`Server responded with an error: ${response.statusText}`);
            const data = await response.json();
            
            let html = '';
            // Dashboard cases are handled above
            if (currentUser.role === 'student') {
                switch(path) {
                    case 'academics': html = studentAcademics(data); break;
                    case 'fees': html = studentFees(data); break;
                    case 'library': html = studentLibrary(data); break;
                    case 'hostel': html = studentHostel(data); break;
                }
            } else if (currentUser.role === 'admin') {
                switch(path) {
                    case 'students': html = adminStudents(data); break;
                    case 'fees_all': html = adminFeesAll(data); break;
                    case 'academics_all': html = adminAcademicsAll(data); break;
                    case 'library_all': html = adminLibraryAll(data); break;
                    case 'hostel_all': html = adminHostelAll(data); break;
                }
            }
            content.innerHTML = `<div class="fade-in">${html}</div>`;

        } catch (error) {
            content.innerHTML = `<div class="text-red-500 bg-red-100 p-4 rounded-lg"><strong>Error:</strong> Could not load data. <br><small>${error.message}</small></div>`;
        }
    }

    // --- HTML TEMPLATES (STUDENT) ---

    function studentDashboard() {
        // --- STABILITY FIX: This function now returns hardcoded HTML ---
        const cardsHtml = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-graduation-cap text-3xl text-blue-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">CGPA</h3><p class="text-3xl font-bold text-blue-600">8.20</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-user-check text-3xl text-green-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Attendance</h3><p class="text-3xl font-bold text-green-600">85.5%</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-rupee-sign text-3xl text-red-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Pending Fees</h3><p class="text-3xl font-bold text-red-600">₹50,000</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-book text-3xl text-yellow-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Books Issued</h3><p class="text-3xl font-bold text-yellow-600">3</p></div></div>
            </div>
        `;
        
        const announcementsHtml = `
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Latest Announcements</h3>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center mr-4">
                            <i class="fas fa-file-alt text-lg"></i>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-gray-800">Mid-Term Exam Schedule</p>
                                <span class="text-xs text-gray-500">25 Sep, 2025</span>
                            </div>
                            <p class="text-gray-600 text-sm mt-1">The schedule for the upcoming mid-term examinations has been published. Please check the college website.</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-star text-lg"></i>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-gray-800">Annual Tech Fest 'Innovate 2025'</p>
                                <span class="text-xs text-gray-500">22 Sep, 2025</span>
                            </div>
                            <p class="text-gray-600 text-sm mt-1">Registrations for the annual tech fest are now open. Participate in exciting events and workshops!</p>
                        </div>
                    </div>
                </div>
            </div>`;

        return cardsHtml + announcementsHtml;
    }

    function studentAcademics(data) { if (!data || data.length === 0) return '<p>No academic records found.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Academic Records</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Semester</th><th class="py-2 px-4 text-left">Attendance</th><th class="py-2 px-4 text-left">CGPA</th></tr></thead><tbody>${data.map(rec => `<tr><td class="py-2 px-4">${rec.semester}</td><td class="py-2 px-4">${rec.attendance}%</td><td class="py-2 px-4">${rec.cgpa}</td></tr>`).join('')}</tbody></table></div></div>`;}
    function studentFees(data) { if (!data || data.length === 0) return '<p>No fee records found.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Fee History</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Amount</th><th class="py-2 px-4 text-left">Status</th><th class="py-2 px-4 text-left">Action</th></tr></thead><tbody>${data.map(fee => `<tr><td class="py-2 px-4">₹${fee.amount}</td><td class="py-2 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${fee.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${fee.status}</span></td><td class="py-2 px-4">${fee.status === 'Pending' ? '<button class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">Pay Now</button>' : '<button class="bg-gray-400 text-white px-3 py-1 rounded-md text-sm cursor-not-allowed">Paid</button>'}</td></tr>`).join('')}</tbody></table></div></div>`;}
    function studentLibrary(data) { if (!data || data.length === 0) return '<div class="bg-white p-6 rounded-lg shadow-md"><p>No books are currently issued to you.</p></div>'; const today = new Date(); return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Issued Books</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Book Title</th><th class="py-2 px-4 text-left">Issue Date</th><th class="py-2 px-4 text-left">Due Date</th><th class="py-2 px-4 text-left">Status</th><th class="py-2 px-4 text-left">Fine</th></tr></thead><tbody>${data.map(book => { const dueDate = new Date(book.due_date); const isOverdue = !book.return_date && today > dueDate; return `<tr class="${isOverdue ? 'bg-red-50' : ''}"><td class="py-2 px-4">${book.title}</td><td class="py-2 px-4">${book.issue_date}</td><td class="py-2 px-4">${book.due_date}</td><td class="py-2 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-.full ${isOverdue ? 'bg-red-100 text-red-800' : 'bg-red-100 text-red-800'}">${isOverdue ? 'Overdue' : 'Issued'}</span></td><td class="py-2 px-4 font-bold ${book.fine > 0 ? 'text-red-600' : ''}">₹${parseFloat(book.fine).toFixed(2)}</td></tr>`; }).join('')}</tbody></table></div></div>`;}
    function studentHostel(data) { if (data && data.room_number) { return `<div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-hotel text-3xl text-indigo-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Hostel Room Allocated</h3><p class="text-3xl font-bold text-indigo-600">${data.room_number}</p></div></div>`; } else { return `<div class="bg-white p-6 rounded-lg shadow-md"><p>You have not been allocated a hostel room.</p></div>`; }}

    // --- HTML TEMPLATES (ADMIN) ---
    function adminDashboard() {
        // This function returns hardcoded HTML and does not need data passed to it.
        return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-user-graduate text-3xl text-blue-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Total Students</h3><p class="text-3xl font-bold text-blue-600">2,847</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-file-invoice-dollar text-3xl text-red-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Fee Collection</h3><p class="text-3xl font-bold text-red-600">₹45.2L</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-hotel text-3xl text-yellow-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Hostel Occupancy</h3><p class="text-3xl font-bold text-yellow-600">89%</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><i class="fas fa-book-reader text-3xl text-green-500 mr-4"></i><div><h3 class="text-gray-500 font-semibold">Library Books</h3><p class="text-3xl font-bold text-green-600">12,450</p></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Admission Trends</h3>
                    <canvas id="admissionsChartCanvas"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Fee Collection Status</h3>
                    <canvas id="feesChartCanvas"></canvas>
                </div>
            </div>`;
    }

    function adminStudents(data) {
        if (!data || data.length === 0) return '<p>No students found.</p>';
         return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Student Roster</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Name</th><th class="py-2 px-4 text-left">Email</th><th class="py-2 px-4 text-left">Department</th></tr></thead><tbody>${data.map(s => `<tr><td class="py-2 px-4">${s.name}</td><td class="py-2 px-4">${s.email}</td><td class="py-2 px-4">${s.dept_name}</td></tr>`).join('')}</tbody></table></div></div>`;
    }

    // --- Admin Template Functions ---
    function adminFeesAll(data) { if (!data || data.length === 0) return '<p>No fee records found.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">All Fee Records</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Student Name</th><th class="py-2 px-4 text-left">Amount</th><th class="py-2 px-4 text-left">Status</th></tr></thead><tbody>${data.map(fee => `<tr><td class="py-2 px-4">${fee.student_name}</td><td class="py-2 px-4">₹${fee.amount}</td><td class="py-2 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${fee.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${fee.status}</span></td></tr>`).join('')}</tbody></table></div></div>`;}
    function adminAcademicsAll(data) { if (!data || data.length === 0) return '<p>No academic records found.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">All Academic Records</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Student Name</th><th class="py-2 px-4 text-left">Semester</th><th class="py-2 px-4 text-left">CGPA</th><th class="py-2 px-4 text-left">Attendance</th></tr></thead><tbody>${data.map(rec => `<tr><td class="py-2 px-4">${rec.student_name}</td><td class="py-2 px-4">${rec.semester}</td><td class="py-2 px-4">${rec.cgpa}</td><td class="py-2 px-4">${rec.attendance}%</td></tr>`).join('')}</tbody></table></div></div>`;}
    function adminLibraryAll(data) { if (!data || data.length === 0) return '<p>No books currently issued.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">All Issued Books</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Student Name</th><th class="py-2 px-4 text-left">Book Title</th><th class="py-2 px-4 text-left">Due Date</th><th class="py-2 px-4 text-left">Fine</th></tr></thead><tbody>${data.map(book => `<tr><td class="py-2 px-4">${book.student_name}</td><td class="py-2 px-4">${book.book_title}</td><td class="py-2 px-4">${book.due_date}</td><td class="py-2 px-4 font-bold text-red-600">₹${parseFloat(book.fine).toFixed(2)}</td></tr>`).join('')}</tbody></table></div></div>`;}
    function adminHostelAll(data) { if (!data || data.length === 0) return '<p>No students allocated to hostel rooms.</p>'; return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Hostel Allocations</h3><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Student Name</th><th class="py-2 px-4 text-left">Room Number</th><th class="py-2 px-4 text-left">Department</th></tr></thead><tbody>${data.map(alloc => `<tr><td class="py-2 px-4">${alloc.student_name}</td><td class="py-2 px-4">${alloc.room_number}</td><td class="py-2 px-4">${alloc.dept_name}</td></tr>`).join('')}</tbody></table></div></div>`;}

    // --- CHART RENDERING ---
    function renderAdminCharts() {
        if (admissionsChart) admissionsChart.destroy();
        if (feesChart) feesChart.destroy();
        const admissionsCtx = document.getElementById('admissionsChartCanvas').getContext('2d');
        admissionsChart = new Chart(admissionsCtx, {type: 'bar', data: {labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{label: 'Admissions', data: [35, 40, 65, 80, 110, 70], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1}]}, options: {responsive: true, scales: {y: {beginAtZero: true}}}});
        const feesCtx = document.getElementById('feesChartCanvas').getContext('2d');
        feesChart = new Chart(feesCtx, {type: 'doughnut', data: {labels: ['Paid', 'Pending', 'Overdue'], datasets: [{data: [85, 12, 3], backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: ['rgba(16, 185, 129, 1)','rgba(239, 68, 68, 1)','rgba(245, 158, 11, 1)'], borderWidth: 1}]}, options: {responsive: true}});
    }

    // --- CORE APP LOGIC ---
    function navigateTo(path) { renderContent(path); }
    function initializeApp(user) { currentUser = user; loginRegisterScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); userInfo.innerHTML = `<p class="font-semibold">${currentUser.username}</p><p class="text-xs text-blue-200">${currentUser.role}</p>`; renderSidebar(); document.querySelector('.sidebar-link[data-path="dashboard"]').click(); }
    async function handleLogout() { await fetch('api/logout.php'); currentUser = null; appScreen.classList.add('hidden'); loginRegisterScreen.classList.remove('hidden'); document.getElementById('username').value = ''; document.getElementById('password').value = ''; loginError.classList.add('hidden'); }
    
    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', async (e) => { e.preventDefault(); loginError.classList.add('hidden'); const username = document.getElementById('username').value; const password = document.getElementById('password').value; try { const response = await fetch('api/login.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const result = await response.json(); if (result.success) { initializeApp(result.user); } else { loginError.textContent = result.message; loginError.classList.remove('hidden'); } } catch (error) { loginError.textContent = 'An error occurred. Please try again.'; loginError.classList.remove('hidden'); } });
    
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        registerMessage.classList.add('hidden');
        const formData = {
            name: document.getElementById('reg-name').value,
            email: document.getElementById('reg-email').value,
            phone: document.getElementById('reg-phone').value,
            dept_id: document.getElementById('reg-dept').value,
            year: 1, // Defaulting year and semester
            semester: 1,
            username: document.getElementById('reg-username').value,
            password: document.getElementById('reg-password').value
        };

        try {
            const response = await fetch('api/register.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            registerMessage.textContent = result.message;
            if (result.success) {
                registerMessage.classList.remove('text-red-500');
                registerMessage.classList.add('text-green-500');
                registerForm.reset();
            } else {
                registerMessage.classList.remove('text-green-500');
                registerMessage.classList.add('text-red-500');
            }
            registerMessage.classList.remove('hidden');

        } catch (error) {
            registerMessage.textContent = 'A network error occurred. Please try again.';
            registerMessage.classList.remove('text-green-500');
            registerMessage.classList.add('text-red-500');
            registerMessage.classList.remove('hidden');
        }
    });

    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginFormContainer.classList.add('hidden');
        registerFormContainer.classList.remove('hidden');
    });

    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        registerFormContainer.classList.add('hidden');
        loginFormContainer.classList.remove('hidden');
    });

    logoutBtn.addEventListener('click', handleLogout);
    (async () => { try { const response = await fetch('api/session.php'); const result = await response.json(); if (result.loggedIn) { initializeApp(result.user); } } catch(e) { /* No active session */ } })();
</script>
</body>
</html>

